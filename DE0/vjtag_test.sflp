
// VirtualJTAGƒeƒXƒg

%i "seg7_ctrl.h"
%i "vjtag_uart.h"

circuit vjtag_test
{
	output HEX0<7>, HEX1<7>, HEX2<7>, HEX3<7>;
	seg7_ctrl seg7_0, seg7_1, seg7_2, seg7_3;
	sel seg<16>;
	output LEDG<10>;

	vjtag_uart vjtag;

	reg_wr recv_sum<8>, send_sum<8>;
	mem ram[32768]<8>;
	reg_wr ram_dout<8>, adrs<15>;


	HEX3 = seg7_3.con(seg<15:12>).oSEG;
	HEX2 = seg7_2.con(seg<11: 8>).oSEG;
	HEX1 = seg7_1.con(seg< 7: 4>).oSEG;
	HEX0 = seg7_0.con(seg< 3: 0>).oSEG;

	seg = send_sum || recv_sum;

	LEDG = adrs<9:0>;

	instruct vjtag.recv_init par{
		adrs := 0;
		recv_sum := 0x00;
	}

	instruct vjtag.recv par{
		ram[adrs] := vjtag.recv_data;
		adrs++;
		recv_sum += vjtag.recv_data;
	}

	instruct vjtag.send_init par{
		adrs := 0;
		send_sum := 0x00;
	}

	reg_wr send_set;
	instruct vjtag.send_ready par{
		ram_dout := ram[adrs];
		adrs++;
		send_set := 0b1;
	}
	if(send_set){
		vjtag.send(ram_dout);
		send_sum += ram_dout;
		send_set := 0b0;
	}

}
